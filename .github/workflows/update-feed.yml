name: Update Digg Daily Feed

on:
  # Run daily at 2 PM UTC (9 AM ET / 6 AM PT)
  # Digg Daily is typically posted in the morning ET
  schedule:
    - cron: '0 14 * * *'
  
  # Also allow manual trigger
  workflow_dispatch:
  
  # Run on push to main for testing
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Generate RSS feed
        run: |
          python feed_generator.py --limit 50 --output feed.xml
          
          # Move output to public directory for GitHub Pages
          mkdir -p public
          mv output/feed.xml public/feed.xml
          
          # Copy images folder for artwork and Open Graph
          cp -r images public/images
          
          # Create a simple index page
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <!-- Google tag (gtag.js) -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-DMQYBNJH13"></script>
            <script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', 'G-DMQYBNJH13');
            </script>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Digg Daily Podcast Feed</title>
            
            <!-- Open Graph / Facebook -->
            <meta property="og:type" content="website">
            <meta property="og:url" content="https://pixelnated.github.io/digg-daily-rss/">
            <meta property="og:title" content="Digg Daily Podcast Feed">
            <meta property="og:description" content="Unofficial podcast feed for the official AI-generated Digg Daily news digest. Subscribe in any podcast app.">
            <meta property="og:image" content="https://pixelnated.github.io/digg-daily-rss/images/digg-daily-rss-logo.jpeg">
            <meta property="og:image:width" content="1280">
            <meta property="og:image:height" content="720">
            
            <!-- Twitter -->
            <meta name="twitter:card" content="summary_large_image">
            <meta name="twitter:url" content="https://pixelnated.github.io/digg-daily-rss/">
            <meta name="twitter:title" content="Digg Daily Podcast Feed">
            <meta name="twitter:description" content="Unofficial podcast feed for the official AI-generated Digg Daily news digest. Subscribe in any podcast app.">
            <meta name="twitter:image" content="https://pixelnated.github.io/digg-daily-rss/images/digg-daily-rss-logo.jpeg">
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                max-width: 600px;
                margin: 50px auto;
                padding: 20px;
                background: #1a1a2e;
                color: #eee;
              }
              h1 { color: #4a9eff; }
              a { color: #4a9eff; }
              .feed-url {
                background: #2a2a4e;
                padding: 15px;
                border-radius: 8px;
                word-break: break-all;
                margin: 20px 0;
              }
              code { 
                background: #3a3a5e; 
                padding: 2px 6px; 
                border-radius: 4px;
              }
              .subscribe-btn {
                display: inline-block;
                background: #4a9eff;
                color: #000;
                padding: 12px 24px;
                border-radius: 8px;
                text-decoration: none;
                font-weight: bold;
                margin: 10px 5px 10px 0;
              }
              .subscribe-btn:hover { background: #6ab0ff; }
            </style>
          </head>
          <body>
            <img src="images/digg-daily-rss-logo.jpeg" alt="Digg Daily RSS" style="max-width: 300px; margin-bottom: 20px; border-radius: 12px;">
            <h1>üìª Digg Daily Podcast Feed</h1>
            <p>
              Listen to <strong>Digg Daily</strong> in your favorite podcast app ‚Äî no browser required.
            </p>
            <p style="background: #2a2a4e; padding: 15px; border-radius: 8px; border-left: 4px solid #4a9eff;">
              <strong>‚ö†Ô∏è Note:</strong> This feed does <strong>not</strong> create the AI audio content. 
              Digg Daily is produced entirely by <a href="https://digg.com">Digg.com</a>. 
              This is an unofficial, community-created RSS wrapper that makes it easier to listen on the go.
            </p>
            
            <h2>Subscribe</h2>
            <p>Copy this feed URL and add it to your podcast app:</p>
            <div class="feed-url">
              <code id="feed-url"></code>
            </div>
            
            <a class="subscribe-btn" href="#" id="copy-btn">üìã Copy Feed URL</a>
            <a class="subscribe-btn" href="feed.xml">üìÑ View RSS Feed</a>
            
            <h2>How to Subscribe</h2>
            <ul>
              <li><strong><a href="https://www.apple.com/apple-podcasts/">Apple Podcasts</a>:</strong> Library ‚Üí Add Show by URL</li>
              <li><strong><a href="https://pocketcasts.com/">Pocket Casts</a>:</strong> Search ‚Üí Enter RSS URL</li>
              <li><strong><a href="https://overcast.fm/">Overcast</a>:</strong> Add URL ‚Üí Paste feed URL</li>
              <li><strong><a href="https://antennapod.org/">AntennaPod</a>:</strong> + ‚Üí Add podcast by URL</li>
              <li><strong><a href="https://podcastaddict.com/">Podcast Addict</a>:</strong> + ‚Üí Add by RSS URL</li>
              <li><strong><a href="https://castro.fm/">Castro</a>:</strong> Settings ‚Üí Subscribe by URL</li>
            </ul>
            
            <h2>About</h2>
            <p>
              This feed is automatically updated daily. It pulls audio directly from Digg's 
              servers and wraps it in a standard podcast RSS format.
            </p>
            <p>
              <strong>We are not affiliated with Digg.com.</strong> All audio content is created, 
              owned, and hosted by Digg. We simply provide a convenient way to subscribe in podcast apps.
            </p>
            <p>
              <a href="https://github.com/pixelnated/digg-daily-rss">View source on GitHub</a> |
              Created by <a href="https://digg.com/u/pixelnated">@pixelnated</a>
            </p>
            
            <script>
              const feedUrl = window.location.href.replace(/\/?$/, '/') + 'feed.xml';
              document.getElementById('feed-url').textContent = feedUrl;
              document.getElementById('copy-btn').onclick = function(e) {
                e.preventDefault();
                navigator.clipboard.writeText(feedUrl);
                this.textContent = '‚úì Copied!';
                setTimeout(() => this.textContent = 'üìã Copy Feed URL', 2000);
              };
            </script>
          </body>
          </html>
          EOF
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
